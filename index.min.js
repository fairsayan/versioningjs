!function(a){var b=3;a.versioningLabel="versioning",a.strMapping=function(a,c){for(var d=[],e=0,f=0;a.length>=b;){var g,h=b,i=null;do{var j=a.substring(0,h++);g=c.indexOf(j),g!==-1&&(i=g)}while(g!==-1&&h-1<=a.length);h-=2,null!==i?(d.push({currentPos:e,previousPos:f+i,size:h}),a=a.substring(h),c=c.substring(i+h),e+=h,f+=i+h):(a=a.substring(1),e++)}return d},a.strDiff=function(b,c){for(var d=a.strMapping(b,c),e=[],f=d.length-1;f>=0;f--){var g=f<d.length-1?d[f+1].currentPos:b.length,h=f<d.length-1?d[f+1].previousPos:c.length,i={start:d[f].currentPos+d[f].size,size:g-d[f].currentPos-d[f].size,substitution:c.substring(d[f].previousPos+d[f].size,h)};(i.size>0||""!==i.substitution)&&e.push(i)}if(d.length>0){var j={start:0,size:d[0].currentPos,substitution:c.substring(0,d[0].previousPos)};(j.size>0||""!==j.substitution)&&e.push(j)}else b!==c&&e.push({start:0,size:b.length,substitution:c});return e},a.strGetPrevious=function(a,b){for(var c=0;c<b.length;c++){var d=a.substring(0,b[c].start),e=a.substring(b[c].start+b[c].size,a.length);a=d+b[c].substitution+e}return a};var c=function(b,c){var d,e=!1;return"undefined"==typeof c&&(c={}),"undefined"==typeof c.versioning?(e=!0,d=b[a.versioningLabel],"undefined"==typeof d&&(d={history:[]}),b[a.versioningLabel]=void 0):(d=c.versioning,"undefined"==typeof d&&(d={history:[]}),"undefined"==typeof d.history&&(d.history=[])),{versioning:d,isVersioningInsideData:e,isDeleted:d.history.length>0&&"deleted"===d.history[d.history.length-1].action}};a.push=function(b,d){var e=c(b,d);if(e.isDeleted)return!1;var f=e.versioning.history,g=JSON.stringify(b);return f.length>0?f.push({action:"updated",date:new Date,diff:a.strDiff(g,e.versioning.strLast)}):f.push({action:"created",date:new Date}),e.versioning.strLast=g,e.isVersioningInsideData&&(b[a.versioningLabel]=e.versioning),!0},a.pop=function(b,d){var e=c(b,d),f=e.versioning.history;if(0!==f.length){var g=e.versioning.strLast,h=f.pop();if("created"!==h.action){"deleted"!==h.action&&(e.versioning.strLast=a.strGetPrevious(g,h.diff));var i=JSON.parse(e.versioning.strLast);return e.isVersioningInsideData&&(i[a.versioningLabel]=e.versioning),i}}},a.delete=function(b,d){var e=c(b,d);if(e.isDeleted)return!1;var f=e.versioning.history;return f.push({action:"deleted",date:new Date}),e.isVersioningInsideData&&(b[a.versioningLabel]=e.versioning),!0},a.rollback=function(b,d){for(var e=c(b,d),f=e.versioning.history,g=e.versioning.strLast,h=!1,i=f.length-1;i>=0&&!h;i--){var j=f[i];"rollback"!==j.action&&"created"!==j.action&&(h=!0),"rollback"!==j.action&&"updated"!==j.action||(g=a.strGetPrevious(g,j.diff))}if(h){var k=JSON.parse(g);return f.push({action:"rollback",date:new Date,diff:a.strDiff(g,e.versioning.strLast)}),e.versioning.strLast=g,e.isVersioningInsideData&&(k[a.versioningLabel]=e.versioning),k}}}("undefined"==typeof exports?this.versioning={}:exports);